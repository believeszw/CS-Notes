# 音频基本概念

在做小视频和 sdk 互通时，由于 rtmp 推的流音频是 aac 的，需要做解析或解码，顾整理一下相关知识点

## 声音原理

声音的频率一般会以 赫兹(Hz) 表示，指每秒周期性震动的次数

* 频率：音调越高，频率越大；音调越低，频率越小。

* 波长：音调越高，波长越短；音调越低，波长越长。（频率高波长短）

* 振幅：音量（响度）越大，振幅越大；音量越小，振幅越小。

> 人耳可以感知到 20Hz ～ 20,000HZ 频率的声音，标准状况下的空气中，上述音波对应的波长 17m ～ 17mm

## 基本概念

### PCM

> In signal processing, sampling is the reduction of a continuous-time signal to a discrete-time signal.\
> pcm 是脉冲编码调制，简单说就是在录制音频是对连续音频信号抽样，以 0 和 1 的数字形式记录，所以 PCM 不是连续音频；

* **Sample**

信号处理中，指将连续时间的信号减少成离散时间的信号

数码音频系统是通过将声波波形转换成一连串的二进制数据来再现原始声音，和我们的视频一样，视频其实就是用图片不断的采样组合而成。

* **Sample Rate**

> Sample Rate is the number of samples of audio carried per second.\
> 采样率就是每秒对音频采样的次数。

采样率表示音频信号每秒的数字快照数。该速率决定了音频文件的频率范围。采样率越高，数字波形的形状越接近原始模拟波形。低采样率会限制可录制的频率范围，这可导致录音表现原始声音的效果不佳。

<div align="center"> <img src="pic/sample_rate.png" width="900px"> </div><br>

* **Channel**

> 声道数（ 1-8 ）声道的个数可以理解为有多少个采样点采样，采样点越多表示越多的表达方式

单声道在声音处理过程中只有单数据流，而立体声则需要左、右声道的两个数据流。显然，立体声的效果要好，但相应的数据量要比单声道的数据量加倍。

* **Audio bit depth**

> In digital audio using pulse-code modulation (PCM), bit depth is the number of bits of information in each sample, and it directly corresponds to the resolution of each sample.\
在使用脉冲编码调制（PCM）的数字音频中，bit depth 是每个 Sample (采样)点占用的位数，并且它直接对应于每个采样的分辨率。

Audio bit depth 一般为 16 位，即采样时用 16 位来表示一个音频采样点.

* **Bit Rate**

> 比特率是指每秒传送的比特 (bit) 数。单位为 bps(Bit Per Second)，比特率越高，传送数据速度越快。声音中的比特率是指将模拟声音信号转换成数字声音信号后，单位时间内的二进制数据量，是间接衡量音频质量的一个指标

Bit Rate(bps) = Sample Rate × Audio bit depth × Channel
即 比特率 (bps) = 采样频率 × 采样位数 × 声道数

* **Frame**

> A frame is a collection of time-coincident samples. For instance, a linear PCM stereo sound file has two samples per frame, one for the left channel and one for the right channel.\
frame 是离散采样的集合，例如，一个 linear PCM stereo sound 文件中每个 frame 有两个采样，分别来自左声道和右声道。

frame 是最小单位时间点包含的一个或多个声音采样，最小单位时间点取决于声音采样设备，是一个时间点多个采样的集合。

* **Packet**

> A packet is a collection of one or more contiguous frames. A packet defines the smallest meaningful set of frames for a given audio data format, and is the smallest data unit for which time can be measured. In linear PCM audio, a packet holds a single frame. In compressed formats, it typically holds more; in some formats, the number of frames per packet varies.\
Packet 是一个或者多个连续 frame 的集合。对于一个给定的音频数据格式，Packet 定义了定义了最小有意义的 frame 集合，并且是最小的可测量时间单位。

下图展示了 Packet、Frame 和 Sample 的关系。

<div align="center"> <img src="pic/packet.png" width="900px"> </div><br>

在未压缩的音频中，一个 Packet 只有一个 frame ;
在压缩的音频中，一个 Packet 是不可再分割的压缩数据块，例如在一个 AAC 格式的 Packet 中就包含了 1024 个采样帧；

* **iOS录音基本单位**

在微信项目中有大量场景使用到 CoreAudio，基本概念先围绕基本的数据类型介绍

AudioStreamBasicDescription 是在使用 AudioQueue 进行语音录音时要传给 AudioQueueNewInput 方法的结构体。

该结构体封装了一个音频流所有的基本描述信息，该数据结构对描述一个不同声道相同且恒定 bitrate 的音频格式是足够的，所以在微信中我们一般使用这个结构来描述。

```Cpp
struct AudioStreamBasicDescription
{
    Float64 mSampleRate;
    AudioFormatID mFormatID;
    AudioFormatFlags mFormatFlags;
    UInt32 mBytesPerPacket;
    UInt32 mFramesPerPacket;
    UInt32 mBytesPerFrame;
    UInt32 mChannelsPerFrame;
    UInt32 mBitsPerChannel;
    UInt32 mReserved;
};
```

其中定义的数据进行注释。

* mFormatID

> 一般用 kAudioFormatLinearPCM，Linear-PCM 是 PCM 的一种，具备比普通 CD 音频中的 PCM 数码流更高的位深和采样率，音质好很多。

* mSampleRate

> The number of sample frames per second of the data in the stream.

* mChannelsPerFrame

> The number of channels in each frame of data.

* mBytesPerFrame

> The number of bytes in a single sample frame of data.

* mFramesPerPacket

> The number of sample frames in each packet of data.

* mBytesPerPacket

> The number of bytes in a packet of data.

结合日常录音开发中其中使用的设置。



<style>th{text-align:center}</style>
<table>
<thead>
<tr>
  <th> Property </th><th> Definition </th><th> Example </th>
</tr>
</thead>
<tbody>
<tr>
  <td> mSampleRate </td><td> 采样率 </td> <td> 16000 </td>
</tr>
<tr>
 <td> mFormatID </td><td> 格式 </td> <td> kAudioFormatLinearPCM </td>
</tr>
<tr>
<td> mFormatFlags </td><td> 标签格式 </td><td> kLinearPCMFormatFlagIsSignedInteger
kLinearPCMFormatFlagIsPacked
 </td>
</tr>
<tr>
<td> mBitsPerChannel </td><td> 语音每采样点占用位数 </td><td> [8/16/24/32] </td>
</tr>
<tr>
<td> mChannelsPerFrame </td><td> 声道数 </td><td> 1:单声道；2:立体声 </td>
</tr>
<tr>
<td> mBytesPerFrame </td><td> 每帧的byte数 </td><td> mBitsPerChannel * mChannelsPerFrame / 8 </td>
</tr>
<tr>
<td> mFramesPerPacket </td><td> 每个Packet的帧数量 </td><td> 1 </td>
</tr>
<tr>
<td> mBytesPerPacket </td><td> 每个Packet的Bytes数量	</td><td> mBytesPerFrame * mFramesPerPacket </td>
</tr>
</tbody>
<table>
